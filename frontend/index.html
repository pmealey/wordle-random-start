<!DOCTYPE html>
<html>
<head>
    <base href="wordle" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Daily Games</title>
    <style>
        body {
            margin: 40px auto;
            max-width: 350px;
            line-height: 1.6;
            font-size: 18px;
            color: #444;
            padding: 0 10px
        }
        h1, h2, h3 {line-height: 1.2;}
        textarea {width: 100%;min-height: 150px;}
        .summary {font-size: 14px;}
        .input-row, textarea {min-width: 200px;}
        .input-row {display: flex; flex-direction: row;}
        .input-row label, .input-row button {flex: 0 0 auto;}
        .input-row * + input, .input-row * + button {margin-left: 5px;}
        .input-row input {flex: 1 1 auto;min-width: 0;}
        .hidden {display: none;visibility: hidden;}
        .result-container, .game-container { border: solid 2px #AAA; padding: 5px; border-radius: 4px; }
        .result-container { display: flex; flex-flow: column; border-color: #444; }
        .result-container div { margin-right: auto; }
        .result-container.copyable div { cursor: pointer; }
        .game-container + .game-container, .result-container + .result-container { margin-top: 5px; }
    </style>
    <meta name="robots" content="noindex" />
</head>
<body>
    <h2>Daily Games</h2>
    <p><i>It's all fun and games until I lose my job because I spend all day every day playing these.</i></p>
    <p>Today's random word: <span id="starting-word">Loading...</span></p>

    <p>
        <button id="see-all">See everyone's results for today</button>
        <button id="see-mine" class="hidden">See just my results for today</button>
    </p>

    <p id="user-area" class="hidden input-row">
        <label for="user">Name:</label>
        <input id="user" type="text" />
        <button id="set-user">Set Name</button>
        <button id="clear-user" class="hidden">Clear</button>
    </p>

    <p id="date-area" class="hidden input-row">
        <label for="date">Date:</label>
        <input id="date" type="text" />
        <button id="refresh">Refresh</button>
    </p>

    <p id="result-id-area" class="hidden input-row">
        <label for="result-id">Result ID:</label>
        <input id="result-id" type="number" />
        <button id="view">View</button>
    </p>

    <p id="delete-area" class="hidden">
        <button id="delete">Delete Matching Results</button>
    </p>

    <p>
        <a href="https://www.nytimes.com/interactive/2022/upshot/wordle-bot.html">Wordle Bot - NYT's Wordle Analysis</a>
    </p>

    <div id="results-area" class="hidden">
        <p>
            <label for="results">Results:</label>
            <br>
            <textarea id="results"></textarea>
            <br>
            <button id="submit">Submit</button>
        </p>

        <div id="summary" class="summary"></div>
        <button id="share">Copy to Clipboard (Share)</button>
    </div>

<script>
function advancedModeEnabled() {
    return location.search.includes('advanced=Y');
}

function requestIsDone(request) {
    return request.readyState === XMLHttpRequest.DONE && request.status >= 200 && request.status < 300;
}

function enterListener(func) {
    return function (ev) {
        if (ev.key == 'Enter') {
            func();
        }
    }
}

function stringToColor(str) {
    if (!str || !str.length) return '#000';
    var hash = 0;
    for (var i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    var colour = '#';
    for (var i = 0; i < 3; i++) {
        var value = (hash >> (i * 8)) & 0xFF;
        colour += ('00' + value.toString(16)).substr(-2);
    }
    return colour + '44';
}


(function() {
    let startingWord = document.getElementById('starting-word');
    let seeAllButton = document.getElementById('see-all');
    let seeMineButton = document.getElementById('see-mine');
    let userArea = document.getElementById('user-area');
    let userInput = document.getElementById('user');
    let setUserButton = document.getElementById('set-user');
    let clearUserButton = document.getElementById('clear-user');
    let dateArea = document.getElementById('date-area');
    let dateInput = document.getElementById('date');
    let refreshButton = document.getElementById('refresh');
    let resultIdArea = document.getElementById('result-id-area');
    let resultIdInput = document.getElementById('result-id');
    let viewButton = document.getElementById('view');
    let deleteArea = document.getElementById('delete-area');
    let deleteButton = document.getElementById('delete');
    let resultsArea = document.getElementById('results-area');
    let resultsTextarea = document.getElementById('results');
    let submitButton = document.getElementById('submit');
    let summaryArea = document.getElementById('summary');
    let shareButton = document.getElementById('share');

    let summaries = [];

    if (advancedModeEnabled()) {
        clearUserButton.classList.remove('hidden');
        dateArea.classList.remove('hidden');
        deleteArea.classList.remove('hidden');
        resultIdArea.classList.remove('hidden');
        seeAllButton.classList.add('hidden');
        shareButton.classList.add('hidden');

        clearUserButton.addEventListener('click', function() {
            userInput.value = '';
            localStorage.removeItem('user');
            refreshData();
        });

        deleteButton.addEventListener('click', function () {
            if (!userInput.value && !resultIdInput.value) {
                return;
            }

            let warningMessage = 'Are you sure you would like to ';

            if (resultIdInput.value) {
                warningMessage += 'delete result ' + resultIdInput.value.toString() + '?';
            } else {
                warningMessage += 'delete all results for user ' + userInput.value;

                if (dateInput.value) {
                    warningMessage += ' on ' + dateInput.value;
                }

                warningMessage += '?';
            }

            if (!confirm(warningMessage)) {
                return;
            }

            let deleteRequest = new XMLHttpRequest();
            deleteRequest.onreadystatechange = function() {
                if (requestIsDone(deleteRequest)) {
                    refreshData();
                }
            }

            let url = '/api/wordle/daily-result/';

            if (resultIdInput.value) {
                url += resultIdInput.value;
            } else {
                url += userInput.value;

                if (dateInput.value) {
                    url += '/' + dateInput.value;
                }
            }

            deleteRequest.open('DELETE', url, false);
            deleteRequest.send();
        });

        refreshButton.addEventListener('click', refreshData);
        dateInput.addEventListener('keyup', enterListener(refreshData));

        viewButton.addEventListener('click', viewResult);
        resultIdInput.addEventListener('keyup', enterListener(viewResult));
    }

    function addGameLink(summary, container) {
        if (summary.dailyResult) {
            let textContainer = document.createElement('div');
            textContainer.innerText = summary.gameName;
            container.appendChild(textContainer);
        } else if (summary.url) {
            let link = document.createElement('a');
            link.href = summary.url;
            link.target = '_blank';
            link.innerText = 'Play ' + summary.gameName;
            container.appendChild(link);
        } else {
            let textContainer = document.createElement('div');
            textContainer.innerText = 'Play ' + summary.gameName;
            container.appendChild(textContainer);
        }
    }

    function addResult(summary, label) {
        let outerContainer = document.createElement('div');
        outerContainer.classList.add('result-container');
        outerContainer.style.backgroundColor = stringToColor(summary.dailyResult.user);

        if (label) {
            let labelContainer = document.createElement('div');
            labelContainer.innerText = label;
            outerContainer.appendChild(labelContainer);
        }

        let container = document.createElement('div');

        function addLineBreak() {
            container.appendChild(document.createElement('br'));
        }

        if (summary.dailyResult) {
            outerContainer.classList.add('copyable');

            if (advancedModeEnabled()) {
                let idSpan = document.createElement('span');
                idSpan.innerText = 'ID: ' + summary.dailyResult.id.toString();
                container.appendChild(idSpan);
                addLineBreak();

                // no user is set, so we are processing all results for a date: include the user info
                if (!userInput.value) {
                    let userSpan = document.createElement('span');
                    userSpan.innerText = 'User: ' + summary.dailyResult.user.toString();
                    container.appendChild(userSpan);
                    addLineBreak();
                }

                // no date is set, so we are processing all results for a user: include the date info
                if (!dateInput.value) {
                    let dateSpan = document.createElement('span');
                    dateSpan.innerText = 'Date: ' + new Date(summary.dailyResult.date).toDateString().toString();
                    container.appendChild(dateSpan);
                    addLineBreak();
                }
            }

            let resultSpan = document.createElement('span');
            resultSpan.innerHTML = summary.dailyResult.result.replaceAll('\n', '<br>');
            container.appendChild(resultSpan);
            container.addEventListener('click', () => {
                setClipboard(summary);
            });
        } else {
            addGameLink(summary, container);
        }

        outerContainer.appendChild(container);

        return outerContainer;
    }

    function clearData() {
        while (summaryArea.children.length) {
            let child = summaryArea.children[0];
            child.remove();
        }
    }

    function refreshData() {
        if (!dateInput.value && !userInput.value || !advancedModeEnabled() && !userInput.value) {
            clearData();
            summaries = [];
            return;
        }

        let viewAll = localStorage.getItem('seeAll') === 'true';

        let summaryRequest = new XMLHttpRequest();
        summaryRequest.onreadystatechange = function() {
            if (requestIsDone(summaryRequest)) {
                let newSummaries = JSON.parse(summaryRequest.responseText);

                clearData();
                summaries = newSummaries;

                if (!viewAll) {
                    newSummaries.forEach((summary) => {
                        let container = addResult(summary);
                        summaryArea.appendChild(container);
                    });
                } else {
                    let allGames = newSummaries
                        .map((summary) => summary.gameName);
                    let games = allGames.filter((game, index) => allGames.indexOf(game) === index);

                    games.forEach((game, index) => {
                        let summariesForGame = newSummaries
                            .filter((summary) => summary.gameName == game);

                        let allUsersForGame = summariesForGame
                            .filter((summary) => summary.dailyResult)
                            .map((summary) => summary.dailyResult.user);
                        let users = allUsersForGame.filter((user, index) => allUsersForGame.indexOf(user) === index);

                        let mySummary = summariesForGame.find(summary => summary.dailyResult && summary.dailyResult.user === userInput.value) ||
                              Object.assign({}, summariesForGame[0], { dailyResult: undefined });

                        let gameContainer = document.createElement('div');
                        gameContainer.classList.add('game-container');
                        gameContainer.style.backgroundColor = stringToColor(mySummary.gameName);
                        addGameLink(mySummary, gameContainer);

                        users.sort()
                            .forEach((user) => {
                                summariesForGame
                                    .filter((summary) => summary.dailyResult && summary.dailyResult.user === user)
                                    .forEach((summary) => {
                                        let container = addResult(summary, user);
                                        gameContainer.appendChild(container);
                                    });
                        });

                        summaryArea.appendChild(gameContainer);
                    });

                }

                resultsArea.classList.remove('hidden');
            }
        }

        let url = '/api/wordle/daily-result';

        if (!viewAll && userInput.value) {
            url += '/' + userInput.value;
        }

        if (dateInput.value) {
            url += '/' + dateInput.value;
        }

        summaryRequest.open('GET', url, false);
        summaryRequest.send();
    }

    function viewResult() {
        if (!resultIdInput.value) {
            return;
        }

        let viewRequest = new XMLHttpRequest();
        viewRequest.onreadystatechange = function() {
            if (requestIsDone(viewRequest)) {
                let result = JSON.parse(viewRequest.responseText);
                alert(result.result);
            }
        }

        viewRequest.open('GET', '/api/wordle/daily-result/' + resultIdInput.value, false);
        viewRequest.send();
    }

    (function initialize() {
        let dailyWordRequest = new XMLHttpRequest();
        dailyWordRequest.onreadystatechange = function() {
            if (requestIsDone(dailyWordRequest)) {
                let response = JSON.parse(dailyWordRequest.responseText);
                startingWord.innerText = response.word;
                dateInput.value = response.date;
                userArea.classList.remove('hidden');

                let user = localStorage.getItem('user');
                if (user) {
                    userInput.value = user;
                }

                refreshData();
            }
        }

        dailyWordRequest.open('GET', '/api/wordle/daily-word', false);
        dailyWordRequest.send();
    })();

    function setUser() {
        if (userInput.value) {
            localStorage.setItem('user', userInput.value);
        }

        refreshData();
    }

    function viewAll() {
        seeAllButton.classList.add('hidden');
        seeMineButton.classList.remove('hidden');
        shareButton.classList.add('hidden');
        localStorage.setItem('seeAll', 'true');
    }

    function viewMine() {
        seeAllButton.classList.remove('hidden');
        seeMineButton.classList.add('hidden');
        shareButton.classList.remove('hidden');
        localStorage.setItem('seeAll', 'false');
    }

    if (!advancedModeEnabled()) {
        let viewingAll = localStorage.getItem('seeAll') === 'true';
        if (viewingAll) {
            viewAll();
        }

        seeAllButton.addEventListener('click', () => {
            viewAll();
            refreshData();
        });

        seeMineButton.addEventListener('click', () => {
            viewMine();
            refreshData();
        });
    }

    setUserButton.addEventListener('click', setUser);
    if (advancedModeEnabled()) {
        userInput.addEventListener('keyup', enterListener(refreshData));
    } else {
        userInput.addEventListener('keyup', enterListener(setUser));
    }

    let submittingResult = false;

    function submitResult() {
        if (submittingResult || !userInput.value || !resultsTextarea.value) {
            return;
        }

        submittingResult = true;

        let submitRequest = new XMLHttpRequest();
        submitRequest.onreadystatechange = function() {
            submittingResult = submitRequest.readyState !== XMLHttpRequest.DONE;
            if (requestIsDone(submitRequest)) {
                refreshData(localStorage.getItem('seeAll') !== 'true');

                let timeout;

                // keep the content around until the user does something
                let handler = function() {
                    clearTimeout(timeout);
                    resultsTextarea.style.color = '';
                    resultsTextarea.value = '';
                    resultsTextarea.removeEventListener('blur', handler);
                    resultsTextarea.removeEventListener('click', handler);
                    resultsTextarea.removeEventListener('keydown', handler);
                }

                resultsTextarea.style.color = '#a0a0a0';
                timeout = setTimeout(handler, 5 * 1000);
                resultsTextarea.addEventListener('blur', handler);
                resultsTextarea.addEventListener('click', handler);
                resultsTextarea.addEventListener('keydown', handler);
            }
        }

        let url = '/api/wordle/daily-result/' + userInput.value;

        if (advancedModeEnabled() && dateInput.value) {
            url +='/' + dateInput.value;
        }

        submitRequest.open('PUT', url, false);
        submitRequest.setRequestHeader('Content-Type', 'application/json');
        submitRequest.send(JSON.stringify(resultsTextarea.value));
    }

    // submit when clicking submit, when pressing enter, or when pasting into the text area
    submitButton.addEventListener('click', submitResult);
    resultsTextarea.addEventListener('keypress', (ev) => ev.key == 'Enter' ? event.preventDefault() : undefined);
    resultsTextarea.addEventListener('keyup', enterListener(submitResult));
    resultsTextarea.addEventListener('paste', function() {
        let handler = function() {
            submitResult();
            resultsTextarea.removeEventListener('input', handler);
        }

        resultsTextarea.addEventListener('input', handler);
    });

    // attempt to try and catch pastes from gboard - if a bunch of text gets added at once, auto-submit
    let oldLength = 0;
    resultsTextarea.addEventListener('input', function() {
        let newLength = resultsTextarea.value.length;
        if (newLength - oldLength > 20) {
            submitResult();
        }
        oldLength = newLength;
    });

    function setClipboard(summary) {
        if (summary == null) {
            navigator.clipboard.writeText(summaries
                .filter(s => s.dailyResult)
                .map(s => s.dailyResult.result).join('\n\n'));
        } else {
            navigator.clipboard.writeText(summary.dailyResult.result);
        }
    }

    shareButton.addEventListener('click', () => setClipboard());
})();
</script>
</body>
</html>
